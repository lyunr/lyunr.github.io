<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高级链接防护系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* 保持原有的CSS样式不变 */
        /* ... */
    </style>
</head>
<body>
    <!-- 保持原有的HTML结构不变 -->
    <!-- ... -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 存储完整URL
            const fullUrls = {
                originalUrl: '',
                antiRedUrl: '',
                antiBlockUrl: ''
            };
            
            // 预定义卡密（实际使用中应从km.html加载）
            let validCardKeys = ["TEST1234", "DEMO5678"];
            
            // 尝试从km.html加载卡密
            function loadCardKeys() {
                return fetch('km.html')
                    .then(response => {
                        if (!response.ok) return;
                        return response.text();
                    })
                    .then(html => {
                        if (!html) return;
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const cardKeysElement = doc.getElementById('cardKeysData');
                        if (cardKeysElement) {
                            try {
                                validCardKeys = JSON.parse(cardKeysElement.textContent);
                                console.log('卡密加载成功');
                            } catch (e) {
                                console.error('卡密解析失败，使用默认卡密');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('加载卡密失败，使用默认卡密:', error);
                    });
            }
            
            // 从本地存储获取已使用的卡密
            function getUsedCardKeys() {
                try {
                    return JSON.parse(localStorage.getItem('usedCardKeys')) || [];
                } catch (e) {
                    return [];
                }
            }
            
            // 存储已使用的卡密到本地
            function markCardKeyAsUsed(key) {
                const usedKeys = getUsedCardKeys();
                if (!usedKeys.includes(key)) {
                    usedKeys.push(key);
                    localStorage.setItem('usedCardKeys', JSON.stringify(usedKeys));
                }
            }
            
            // 验证卡密
            function validateCardKey(key) {
                if (!key) {
                    return { valid: false, message: "请输入卡密" };
                }
                
                if (getUsedCardKeys().includes(key)) {
                    return { valid: false, message: "该卡密已被使用" };
                }
                
                if (validCardKeys.includes(key)) {
                    return { valid: true, message: "卡密验证通过" };
                }
                
                return { valid: false, message: "无效的卡密" };
            }
            
            // 生成随机三位数
            function generateRandomNumber() {
                return Math.floor(Math.random() * 900) + 100;
            }
            
            // Base64编码
            function base64Encode(str) {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, 
                    function(match, p1) {
                        return String.fromCharCode('0x' + p1);
                    }));
            }
            
            // 生成防洪链接
            function generateAntiRedUrl(targetUrl) {
                const randomNum = generateRandomNumber();
                const urlWithRandom = targetUrl.includes('?') 
                    ? `${targetUrl}&rnd=${randomNum}`
                    : `${targetUrl}?rnd=${randomNum}`;
                const base64Url = base64Encode(urlWithRandom);
                return `http://laicai.66ghz.com/c.htm?c=${base64Url}`;
            }
            
            // 生成防拦截链接
            function generateAntiBlockUrl(targetUrl) {
                return `${window.location.origin}/fz.html?url=${encodeURIComponent(targetUrl)}`;
            }
            
            // 生成二维码
            function generateQRCode(url) {
                const qrcodeContainer = document.getElementById('qrcodeCanvas');
                qrcodeContainer.innerHTML = '';
                const size = window.innerWidth < 768 ? 150 : 200;
                new QRCode(qrcodeContainer, {
                    text: url,
                    width: size,
                    height: size,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
            
            // 复制到剪贴板
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('链接已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('链接已复制到剪贴板');
                });
            }
            
            // 打开链接
            function openUrl(url) {
                window.open(url, '_blank');
            }
            
            // 绑定按钮事件
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('copy-icon')) {
                    const targetId = e.target.getAttribute('data-target');
                    copyToClipboard(fullUrls[targetId]);
                }
                
                if (e.target.closest('.copy-btn')) {
                    const btn = e.target.closest('.copy-btn');
                    const targetId = btn.getAttribute('data-target');
                    copyToClipboard(fullUrls[targetId]);
                }
                
                if (e.target.closest('.open-btn')) {
                    const btn = e.target.closest('.open-btn');
                    const targetId = btn.getAttribute('data-target');
                    openUrl(fullUrls[targetId]);
                }
            });
            
            // 初始化并设置生成按钮事件
            loadCardKeys().then(() => {
                document.getElementById('generateBtn').addEventListener('click', function() {
                    // 1. 验证卡密
                    const cardKey = document.getElementById('cardKey').value.trim();
                    const validation = validateCardKey(cardKey);
                    if (!validation.valid) {
                        alert(validation.message);
                        return;
                    }
                    
                    // 2. 验证目标URL
                    const targetUrl = document.getElementById('targetUrl').value.trim();
                    if (!targetUrl) {
                        alert('请输入目标链接');
                        return;
                    }
                    
                    try {
                        new URL(targetUrl);
                    } catch (e) {
                        alert('请输入有效的URL格式，例如: https://example.com');
                        return;
                    }
                    
                    // 3. 标记卡密为已使用
                    markCardKeyAsUsed(cardKey);
                    
                    // 4. 生成链接
                    fullUrls.originalUrl = targetUrl;
                    document.getElementById('originalUrl').textContent = targetUrl;
                    
                    const isAntiRedEnabled = document.getElementById('antiRedSwitch').checked;
                    if (isAntiRedEnabled) {
                        fullUrls.antiRedUrl = generateAntiRedUrl(targetUrl);
                        document.getElementById('antiRedUrl').textContent = fullUrls.antiRedUrl;
                        document.getElementById('antiRedResultContainer').style.display = 'block';
                    } else {
                        document.getElementById('antiRedResultContainer').style.display = 'none';
                    }
                    
                    const finalUrl = isAntiRedEnabled ? fullUrls.antiRedUrl : targetUrl;
                    fullUrls.antiBlockUrl = generateAntiBlockUrl(finalUrl);
                    document.getElementById('antiBlockUrl').textContent = fullUrls.antiBlockUrl;
                    
                    generateQRCode(fullUrls.antiBlockUrl);
                    
                    // 5. 显示结果
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                });
            });
            
            // 禁止缩放
            document.addEventListener('gesturestart', function(e) {
                if (e.scale !== 1) e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('touchmove', function(e) {
                if (e.scale !== 1 && e.scale !== undefined) e.preventDefault();
            }, { passive: false });
        });
    </script>
</body>
</html>
